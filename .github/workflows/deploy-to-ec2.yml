name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper git operations

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: myaiagent-mvp/frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./myaiagent-mvp/frontend
        run: npm ci

      - name: Build frontend for production
        working-directory: ./myaiagent-mvp/frontend
        run: npm run build
        env:
          VITE_API_URL: /api
          VITE_ENABLE_ENHANCED_STT: true

      - name: Create deployment package
        run: |
          echo "Creating deployment archive..."
          tar -czf deployment.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='*.log' \
            myaiagent-mvp/
          echo "âœ… Deployment package created"

      - name: Configure SSH
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          # Write SSH key using environment variable (proper way for multi-line secrets)
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Verify key format and line count
          echo "ğŸ” Checking SSH key format..."
          echo "First line:"
          head -n 1 ~/.ssh/deploy_key
          echo "Last line:"
          tail -n 1 ~/.ssh/deploy_key
          echo "Total lines: $(wc -l < ~/.ssh/deploy_key)"
          echo "Key file size: $(wc -c < ~/.ssh/deploy_key) bytes"

          # Verify it's a valid RSA key
          if head -n 1 ~/.ssh/deploy_key | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "âœ… Key header looks valid"
          else
            echo "âŒ Key header is invalid or missing!"
            echo "Debug: First 50 chars of key file:"
            head -c 50 ~/.ssh/deploy_key
            exit 1
          fi

          # Add SSH options to skip strict host checking and use the key
          cat > ~/.ssh/config <<EOF
          Host ec2-deploy
            HostName ${{ secrets.EC2_HOST }}
            User ${{ secrets.EC2_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF
          chmod 600 ~/.ssh/config

          echo "âœ… SSH configuration completed"

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: ${{ secrets.EC2_DEPLOY_PATH }}
        run: |
          echo "ğŸš€ Starting deployment to EC2..."

          # Test SSH connection
          echo "Testing SSH connection..."
          ssh ec2-deploy 'echo "âœ… SSH connection successful!"'

          # Upload deployment package
          scp deployment.tar.gz ec2-deploy:~/

          # Execute deployment commands on EC2
          ssh ec2-deploy << 'ENDSSH'
            set -e

            echo "ğŸ“¦ Extracting deployment package..."
            cd ~
            tar -xzf deployment.tar.gz
            rm deployment.tar.gz

            echo "ğŸ“‚ Syncing files to deployment directory..."
            sudo rsync -av --delete \
              --exclude='node_modules' \
              --exclude='.env' \
              --exclude='uploads' \
              --exclude='*.db' \
              --exclude='*.sqlite3' \
              --exclude='attached_assets' \
              ~/MY_AI_AGENT/myaiagent-mvp/ ${DEPLOY_PATH}/

            echo "ğŸ”§ Installing backend dependencies..."
            cd ${DEPLOY_PATH}/backend
            npm install

            echo "ğŸ—„ï¸  Running database migrations..."
            if [ -f "run-new-migrations.js" ]; then
              node run-new-migrations.js
              echo "âœ… Database migrations completed"
            else
              echo "âš ï¸  No migration script found, skipping migrations"
            fi

            echo "ğŸ”§ Building frontend..."
            cd ${DEPLOY_PATH}/frontend
            npm install
            npm run build
            echo "âœ… Frontend built successfully"

            echo "ğŸ“‚ Copying frontend to web directory..."
            if [ -d "/var/www/myaiagent" ]; then
              sudo cp -r dist/* /var/www/myaiagent/
              echo "âœ… Frontend copied to /var/www/myaiagent/"
            else
              echo "âš ï¸  /var/www/myaiagent directory not found, skipping frontend copy"
            fi

            echo "ğŸ”„ Restarting application services..."
            # Restart backend service using PM2
            if command -v pm2 &> /dev/null; then
              if pm2 list | grep -q "myaiagent-backend"; then
                pm2 restart myaiagent-backend
                echo "âœ… Restarted myaiagent-backend"
              else
                echo "âš ï¸  myaiagent-backend not found in PM2, attempting to start..."
                cd ${DEPLOY_PATH}/backend
                pm2 start server.js --name myaiagent-backend
              fi
              pm2 save
              pm2 status
            elif systemctl is-active --quiet myaiagent-backend; then
              sudo systemctl restart myaiagent-backend
              echo "âœ… Restarted myaiagent-backend service"
            else
              echo "âš ï¸  PM2 or systemd service not found. Please restart manually."
            fi

            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application should be running at https://werkules.com"
            echo "ğŸ“‹ Check logs with: pm2 logs myaiagent-backend --lines 50"
          ENDSSH

          echo "âœ… EC2 deployment finished"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f deployment.tar.gz

      - name: Deployment notification
        if: success()
        run: |
          echo "âœ… Deployment to EC2 completed successfully!"
          echo "ğŸŒ Application: https://werkules.com"
          echo "ğŸ“… Deployed at: $(date)"
          echo "ğŸ“ Commit: ${{ github.sha }}"

      - name: Deployment failed notification
        if: failure()
        run: |
          echo "âŒ Deployment to EC2 failed!"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "Please check the logs above for details."
